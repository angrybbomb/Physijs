<!DOCTYPE html>

<html>

<head>
	<title>Collisions - Physijs</title>
	<script type="text/javascript" src="js/ThreeDebug.js"></script>
	<script type="text/javascript" src="js/tween.js"></script>
	<script type="text/javascript" src="js/stats.js"></script>
	<script type="text/javascript" src="../physi.js"></script>
	
	<script type="text/javascript">
	
	'use strict';
	
	// http://paulirish.com/2011/requestanimationframe-for-smart-animating/
	// shim layer with setTimeout fallback
	window['requestAnimFrame'] = (function(){
	  return  window.requestAnimationFrame       || 
	          window.webkitRequestAnimationFrame || 
	          window.mozRequestAnimationFrame    || 
	          window.oRequestAnimationFrame      || 
	          window.msRequestAnimationFrame     || 
	          function(/* function */ callback, /* DOMElement */ element){
	            window.setTimeout(callback, 1000 / 60);
	          };
	})();
	
	Physijs.scripts.worker = '../physijs_worker.js';
	Physijs.scripts.ammo = 'examples/js/ammo.js';
	
	var initScene, render, _boxes = [], spawnBox, total_collisions = 0,
		projector, renderer, stats, scene, light, camera;
	
	initScene = function() {
		TWEEN.start();
		
		projector = new THREE.Projector;
		
		renderer = new THREE.WebGLRenderer({ antialias: true });
		renderer.setSize( window.innerWidth, window.innerHeight );
		renderer.shadowMapEnabled = true;
		renderer.shadowMapSoft = true;
		document.getElementById( 'viewport' ).appendChild( renderer.domElement );
		
		stats = new Stats();
		stats.domElement.style.position = 'absolute';
		stats.domElement.style.top = '0px';
		stats.domElement.style.zIndex = 100;
		document.getElementById( 'viewport' ).appendChild( stats.domElement );
		
		scene = new Physijs.Scene;
		scene.setGravity({ x: 0, y: -10, z: 0 });
		
		scene.addEventListener('update', function( details ) {
			total_collisions += details.collisions.length;
			document.getElementById( 'info' ).textContent = total_collisions + ' collisions';
		});
		
		camera = new THREE.PerspectiveCamera(
			35,
			window.innerWidth / window.innerHeight,
			1,
			1000
		);
		camera.position.set( 60, 50, 60 );
		camera.lookAt( scene.position );
		scene.add( camera );
		
		// Light
		light = new THREE.DirectionalLight( 0xFFFFFF );
		light.position.set( 40, 60, 25 );
		light.target.position.copy( scene.position );
		light.castShadow = true;
		light.shadowCameraLeft = -30;
		light.shadowCameraTop = -30;
		light.shadowCameraRight = 30;
		light.shadowCameraBottom = 30;
		light.shadowBias = -.0001
		scene.add( light );
		window.light = light;
		
		// Ground
		var ground = new Physijs.PlaneMesh(
			new THREE.PlaneGeometry(100, 100),
			new THREE.MeshLambertMaterial({ color: 0xDDDDDD }),
			0 // mass
		);
		ground.rotation.x = -Math.PI / 2;
		ground.receiveShadow = true;
		scene.add( ground );
		
		spawnBox();
		
		requestAnimFrame( render );
	};
	
	spawnBox = (function() {
		var box_geometry = new THREE.CubeGeometry( 4, 4, 4 ),
			handleCollision = function() {
				switch ( ++this.collisions ) {
					
					case 1:
						this.material.color.setHex(0xcc8855);
						break;
					
					case 2:
						this.material.color.setHex(0xbb9955);
						break;
					
					case 3:
						this.material.color.setHex(0xaaaa55);
						break;
					
					case 4:
						this.material.color.setHex(0x99bb55);
						break;
					
					case 5:
						this.material.color.setHex(0x88cc55);
						break;
					
					case 6:
						this.material.color.setHex(0x77dd55);
						break;
				}
			};
		
		return function() {
			var box = new Physijs.BoxMesh(
				box_geometry,
				new THREE.MeshLambertMaterial({ color: 0xdd7755 }) // Not shared because of color changes
			);
			box.collisions = 0;
			box.position.set(
				Math.random() * 15 - 7.5,
				25,
				Math.random() * 15 - 7.5
			);
			box.rotation.set(
				Math.random() * Math.PI,
				Math.random() * Math.PI,
				Math.random() * Math.PI
			);
			box.castShadow = true;
			box.addEventListener( 'collision', handleCollision );
			scene.add( box );
			
			setTimeout( spawnBox, 1000 );
		}
	})();
	
	render = function() {
		scene.simulate(undefined, 2);
		renderer.render( scene, camera);
		stats.update();
		requestAnimFrame( render );
	};
	
	window.onload = initScene;
	
	</script>
	
	<style type="text/css">
		html, body {
			margin: 0;
			padding: 0;
			overflow: hidden;
		}
		p {
			font-family: Verdana;
			font-size: 10pt;
			text-align: center;
			position: absolute;
			top: 0;
			width: 100%;
		}
		p a {
			color: #4488ff;
		}
	</style>
</head>

<body>
	<p>
		Demonstrating the collision callbacks<br /><span id="info"></span>
	</p>
	<div id="viewport"></div>
</body>

</html>