<!DOCTYPE html>

<html>

<head>
	<title>Compound Shape - Physijs</title>
	<script type="text/javascript" src="js/ThreeDebug.js"></script>
	<script type="text/javascript" src="js/tween.js"></script>
	<script type="text/javascript" src="js/stats.js"></script>
	<script type="text/javascript" src="../physi.js"></script>
	
	<script type="text/javascript">
	
	'use strict';
	
	// http://paulirish.com/2011/requestanimationframe-for-smart-animating/
	// shim layer with setTimeout fallback
	window['requestAnimFrame'] = (function(){
	  return  window.requestAnimationFrame       || 
	          window.webkitRequestAnimationFrame || 
	          window.mozRequestAnimationFrame    || 
	          window.oRequestAnimationFrame      || 
	          window.msRequestAnimationFrame     || 
	          function(/* function */ callback, /* DOMElement */ element){
	            window.setTimeout(callback, 1000 / 60);
	          };
	})();
	
	Physijs.scripts.worker = '../physijs_worker.js';
	Physijs.scripts.ammo = 'examples/js/ammo.js';
	
	var initScene, render, projector, renderer, stats, scene, light, camera, spawnChair;
	
	initScene = function() {
		TWEEN.start();
		
		projector = new THREE.Projector;
		
		renderer = new THREE.WebGLRenderer({ antialias: true });
		renderer.setSize( window.innerWidth, window.innerHeight );
		renderer.shadowMapEnabled = true;
		renderer.shadowMapSoft = true;
		document.getElementById( 'viewport' ).appendChild( renderer.domElement );
		
		stats = new Stats();
		stats.domElement.style.position = 'absolute';
		stats.domElement.style.top = '0px';
		stats.domElement.style.zIndex = 100;
		document.getElementById( 'viewport' ).appendChild( stats.domElement );
		
		scene = new Physijs.Scene;
		scene.setGravity({ x: 0, y: -10, z: 0 });
		
		camera = new THREE.PerspectiveCamera(
			35,
			window.innerWidth / window.innerHeight,
			1,
			1000
		);
		camera.position.set( 60, 50, 60 );
		camera.lookAt( scene.position );
		scene.add( camera );
		
		// Light
		light = new THREE.DirectionalLight( 0xFFFFFF );
		light.position.set( 40, 60, 25 );
		light.target.position.copy( scene.position );
		light.castShadow = true;
		light.shadowCameraLeft = -30;
		light.shadowCameraTop = -30;
		light.shadowCameraRight = 30;
		light.shadowCameraBottom = 30;
		light.shadowBias = -.0001
		scene.add( light );
		
		// Ground
		var ground = new Physijs.PlaneMesh(
			new THREE.PlaneGeometry(100, 100),
			new THREE.MeshLambertMaterial({ color: 0xDDDDDD }),
			0 // mass
		);
		ground.rotation.x = -Math.PI / 2;
		ground.receiveShadow = true;
		scene.add( ground );
		
		spawnChair();
		
		requestAnimFrame( render );
	};
	
	spawnChair = (function() {
		var buildBack, buildLegs,
			chair_material = new THREE.MeshLambertMaterial({ color: 0xcc6633 });
		
		buildBack = function() {
			var back, _object;
			
			back = new Physijs.BoxMesh(
				new THREE.CubeGeometry( 5, 1, .5 ),
				chair_material
			);
			back.position.y = 5;
			back.position.z = -2.5;
			back.castShadow = true;
			back.receiveShadow = true;
			
			// rungs - relative to back
			_object = new Physijs.BoxMesh(
				new THREE.CubeGeometry( 1, 5, .5 ),
				chair_material
			);
			_object.position.y = -3;
			_object.position.x = -2;
			_object.castShadow = true;
			_object.receiveShadow = true;
			back.add( _object );
			
			_object = new Physijs.BoxMesh(
				new THREE.CubeGeometry( 1, 5, .5 ),
				chair_material
			);
			_object.position.y = -3;
			_object.castShadow = true;
			_object.receiveShadow = true;
			back.add( _object );
			
			_object = new Physijs.BoxMesh(
				new THREE.CubeGeometry( 1, 5, .5 ),
				chair_material
			);
			_object.position.y = -3;
			_object.position.x = 2;
			_object.castShadow = true;
			_object.receiveShadow = true;
			back.add( _object );
			
			return back;
		};
		
		buildLegs = function() {
			var leg, _leg;
			
			// back left
			leg = new Physijs.BoxMesh(
				new THREE.CubeGeometry( .5, 4, .5 ),
				chair_material
			);
			leg.position.x = 2.25;
			leg.position.z = -2.25;
			leg.position.y = -2.5;
			leg.castShadow = true;
			leg.receiveShadow = true;
			
			// back right - relative to back left leg
			_leg = new Physijs.BoxMesh(
				new THREE.CubeGeometry( .5, 4, .5 ),
				chair_material
			);
			_leg.position.x = -4.5;
			_leg.castShadow = true;
			_leg.receiveShadow = true;
			leg.add( _leg );
			
			// front left - relative to back left leg
			_leg = new Physijs.BoxMesh(
				new THREE.CubeGeometry( .5, 4, .5 ),
				chair_material
			);
			_leg.position.z = 4.5;
			_leg.castShadow = true;
			_leg.receiveShadow = true;
			leg.add( _leg );
			
			// front right - relative to back left leg
			_leg = new Physijs.BoxMesh(
				new THREE.CubeGeometry( .5, 4, .5 ),
				chair_material
			);
			_leg.position.x = -4.5;
			_leg.position.z = 4.5;
			_leg.castShadow = true;
			_leg.receiveShadow = true;
			leg.add( _leg );
			
			return leg;
		};
		
		return function spawnChair() {
			var chair, back, legs;
			
			// seat of the chair
			chair = new Physijs.BoxMesh(
				new THREE.CubeGeometry( 5, 1, 5 ),
				chair_material
			);
			chair.castShadow = true;
			chair.receiveShadow = true;
			
			// back - relative to chair ( seat )
			back = buildBack();
			chair.add( back );
			
			// legs - relative to chair ( seat )
			legs = buildLegs();
			chair.add( legs );
			
			chair.position.y = 20;
			chair.position.x = Math.random() * 50 - 25;
			chair.position.z = Math.random() * 50 - 25;
			
			chair.rotation.set(
				Math.random() * Math.PI * 2,
				Math.random() * Math.PI * 2,
				Math.random() * Math.PI * 2
			);
			
			scene.add( chair );
			
			setTimeout( spawnChair, 2000 );
		}
	})();
	
	render = function() {
		scene.simulate(undefined, 2);
		renderer.render( scene, camera);
		stats.update();
		requestAnimFrame( render );
	};
	
	window.onload = initScene;
	
	</script>
	
	<style type="text/css">
		html, body {
			margin: 0;
			padding: 0;
			overflow: hidden;
		}
		p {
			font-family: Verdana;
			font-size: 10pt;
			text-align: center;
			position: absolute;
			top: 0;
			width: 100%;
		}
		p a {
			color: #4488ff;
		}
	</style>
</head>

<body>
	<div id="viewport"></div>
</body>

</html>